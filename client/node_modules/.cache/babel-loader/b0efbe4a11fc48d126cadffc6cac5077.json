{"ast":null,"code":"import \"../../utilities/globals/index.js\";\nimport { useState, useRef, useEffect } from 'react';\nimport { equal } from '@wry/equality';\nimport { DocumentType, verifyDocumentType } from \"../parser/index.js\";\nimport { useApolloClient } from \"./useApolloClient.js\";\nexport function useSubscription(subscription, options) {\n  var client = useApolloClient(options === null || options === void 0 ? void 0 : options.client);\n  verifyDocumentType(subscription, DocumentType.Subscription);\n  var _a = useState({\n      loading: !(options === null || options === void 0 ? void 0 : options.skip),\n      error: void 0,\n      data: void 0,\n      variables: options === null || options === void 0 ? void 0 : options.variables\n    }),\n    result = _a[0],\n    setResult = _a[1];\n  var _b = useState(function () {\n      if (options === null || options === void 0 ? void 0 : options.skip) {\n        return null;\n      }\n      return client.subscribe({\n        query: subscription,\n        variables: options === null || options === void 0 ? void 0 : options.variables,\n        fetchPolicy: options === null || options === void 0 ? void 0 : options.fetchPolicy,\n        context: options === null || options === void 0 ? void 0 : options.context\n      });\n    }),\n    observable = _b[0],\n    setObservable = _b[1];\n  var canResetObservableRef = useRef(false);\n  useEffect(function () {\n    return function () {\n      canResetObservableRef.current = true;\n    };\n  }, []);\n  var ref = useRef({\n    client: client,\n    subscription: subscription,\n    options: options\n  });\n  useEffect(function () {\n    var _a, _b, _c, _d;\n    var shouldResubscribe = options === null || options === void 0 ? void 0 : options.shouldResubscribe;\n    if (typeof shouldResubscribe === 'function') {\n      shouldResubscribe = !!shouldResubscribe(options);\n    }\n    if (options === null || options === void 0 ? void 0 : options.skip) {\n      if (!(options === null || options === void 0 ? void 0 : options.skip) !== !((_a = ref.current.options) === null || _a === void 0 ? void 0 : _a.skip) || canResetObservableRef.current) {\n        setResult({\n          loading: false,\n          data: void 0,\n          error: void 0,\n          variables: options === null || options === void 0 ? void 0 : options.variables\n        });\n        setObservable(null);\n        canResetObservableRef.current = false;\n      }\n    } else if (shouldResubscribe !== false && (client !== ref.current.client || subscription !== ref.current.subscription || (options === null || options === void 0 ? void 0 : options.fetchPolicy) !== ((_b = ref.current.options) === null || _b === void 0 ? void 0 : _b.fetchPolicy) || !(options === null || options === void 0 ? void 0 : options.skip) !== !((_c = ref.current.options) === null || _c === void 0 ? void 0 : _c.skip) || !equal(options === null || options === void 0 ? void 0 : options.variables, (_d = ref.current.options) === null || _d === void 0 ? void 0 : _d.variables)) || canResetObservableRef.current) {\n      setResult({\n        loading: true,\n        data: void 0,\n        error: void 0,\n        variables: options === null || options === void 0 ? void 0 : options.variables\n      });\n      setObservable(client.subscribe({\n        query: subscription,\n        variables: options === null || options === void 0 ? void 0 : options.variables,\n        fetchPolicy: options === null || options === void 0 ? void 0 : options.fetchPolicy,\n        context: options === null || options === void 0 ? void 0 : options.context\n      }));\n      canResetObservableRef.current = false;\n    }\n    Object.assign(ref.current, {\n      client: client,\n      subscription: subscription,\n      options: options\n    });\n  }, [client, subscription, options, canResetObservableRef.current]);\n  useEffect(function () {\n    if (!observable) {\n      return;\n    }\n    var subscription = observable.subscribe({\n      next: function (fetchResult) {\n        var _a, _b;\n        var result = {\n          loading: false,\n          data: fetchResult.data,\n          error: void 0,\n          variables: options === null || options === void 0 ? void 0 : options.variables\n        };\n        setResult(result);\n        (_b = (_a = ref.current.options) === null || _a === void 0 ? void 0 : _a.onSubscriptionData) === null || _b === void 0 ? void 0 : _b.call(_a, {\n          client: client,\n          subscriptionData: result\n        });\n      },\n      error: function (error) {\n        setResult({\n          loading: false,\n          data: void 0,\n          error: error,\n          variables: options === null || options === void 0 ? void 0 : options.variables\n        });\n      },\n      complete: function () {\n        var _a, _b;\n        (_b = (_a = ref.current.options) === null || _a === void 0 ? void 0 : _a.onSubscriptionComplete) === null || _b === void 0 ? void 0 : _b.call(_a);\n      }\n    });\n    return function () {\n      subscription.unsubscribe();\n    };\n  }, [observable]);\n  return result;\n}","map":{"version":3,"names":["useState","useRef","useEffect","equal","DocumentType","verifyDocumentType","useApolloClient","useSubscription","subscription","options","client","Subscription","_a","loading","skip","error","data","variables","result","setResult","_b","subscribe","query","fetchPolicy","context","observable","setObservable","canResetObservableRef","current","ref","shouldResubscribe","_c","_d","Object","assign","next","fetchResult","onSubscriptionData","call","subscriptionData","complete","onSubscriptionComplete","unsubscribe"],"sources":["../../../src/react/hooks/useSubscription.ts"],"sourcesContent":["import '../../utilities/globals';\nimport { useState, useRef, useEffect } from 'react';\nimport { DocumentNode } from 'graphql';\nimport { TypedDocumentNode } from '@graphql-typed-document-node/core';\nimport { equal } from '@wry/equality';\n\nimport { DocumentType, verifyDocumentType } from '../parser';\nimport {\n  SubscriptionHookOptions,\n  SubscriptionResult\n} from '../types/types';\nimport { OperationVariables } from '../../core';\nimport { useApolloClient } from './useApolloClient';\n\nexport function useSubscription<TData = any, TVariables = OperationVariables>(\n  subscription: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: SubscriptionHookOptions<TData, TVariables>,\n) {\n  const client = useApolloClient(options?.client);\n  verifyDocumentType(subscription, DocumentType.Subscription);\n  const [result, setResult] = useState<SubscriptionResult<TData>>({\n    loading: !options?.skip,\n    error: void 0,\n    data: void 0,\n    variables: options?.variables,\n  });\n\n  const [observable, setObservable] = useState(() => {\n    if (options?.skip) {\n      return null;\n    }\n\n    return client.subscribe({\n      query: subscription,\n      variables: options?.variables,\n      fetchPolicy: options?.fetchPolicy,\n      context: options?.context,\n    });\n  });\n\n  const canResetObservableRef = useRef(false);\n  useEffect(() => {\n    return () => {\n      canResetObservableRef.current = true;\n    };\n  }, []);\n\n  const ref = useRef({ client, subscription, options });\n  useEffect(() => {\n    let shouldResubscribe = options?.shouldResubscribe;\n    if (typeof shouldResubscribe === 'function') {\n      shouldResubscribe = !!shouldResubscribe(options!);\n    }\n\n    if (options?.skip) {\n      if (!options?.skip !== !ref.current.options?.skip || canResetObservableRef.current) {\n        setResult({\n          loading: false,\n          data: void 0,\n          error: void 0,\n          variables: options?.variables,\n        });\n        setObservable(null);\n        canResetObservableRef.current = false;\n      }\n    } else if (\n      (shouldResubscribe !== false &&\n        (client !== ref.current.client ||\n          subscription !== ref.current.subscription ||\n          options?.fetchPolicy !== ref.current.options?.fetchPolicy ||\n          !options?.skip !== !ref.current.options?.skip ||\n          !equal(options?.variables, ref.current.options?.variables))) ||\n      canResetObservableRef.current\n    ) {\n      setResult({\n        loading: true,\n        data: void 0,\n        error: void 0,\n        variables: options?.variables,\n      });\n      setObservable(client.subscribe({\n        query: subscription,\n        variables: options?.variables,\n        fetchPolicy: options?.fetchPolicy,\n        context: options?.context,\n      }));\n      canResetObservableRef.current = false;\n    }\n\n    Object.assign(ref.current, { client, subscription, options });\n  }, [client, subscription, options, canResetObservableRef.current]);\n\n  useEffect(() => {\n    if (!observable) {\n      return;\n    }\n\n    const subscription = observable.subscribe({\n      next(fetchResult) {\n        const result = {\n          loading: false,\n          // TODO: fetchResult.data can be null but SubscriptionResult.data\n          // expects TData | undefined only\n          data: fetchResult.data!,\n          error: void 0,\n          variables: options?.variables,\n        };\n        setResult(result);\n\n        ref.current.options?.onSubscriptionData?.({\n          client,\n          subscriptionData: result\n        });\n      },\n      error(error) {\n        setResult({\n          loading: false,\n          data: void 0,\n          error,\n          variables: options?.variables,\n        });\n      },\n      complete() {\n        ref.current.options?.onSubscriptionComplete?.();\n      },\n    });\n\n    return () => {\n      subscription.unsubscribe();\n    };\n  }, [observable]);\n\n  return result;\n}\n"],"mappings":"AAAA,OAAO,kCAA0B;AACjC,SAASA,QAAQ,EAAEC,MAAM,EAAEC,SAAS,QAAQ,OAAO;AAGnD,SAASC,KAAK,QAAQ,eAAe;AAErC,SAASC,YAAY,EAAEC,kBAAkB,QAAQ,oBAAY;AAM7D,SAASC,eAAe,QAAQ,sBAAoB;AAEpD,OAAM,SAAUC,eAAeA,CAC7BC,YAAiE,EACjEC,OAAoD;EAEpD,IAAMC,MAAM,GAAGJ,eAAe,CAACG,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEC,MAAM,CAAC;EAC/CL,kBAAkB,CAACG,YAAY,EAAEJ,YAAY,CAACO,YAAY,CAAC;EACrD,IAAAC,EAAA,GAAsBZ,QAAQ,CAA4B;MAC9Da,OAAO,EAAE,EAACJ,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEK,IAAI;MACvBC,KAAK,EAAE,KAAK,CAAC;MACbC,IAAI,EAAE,KAAK,CAAC;MACZC,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ;KACrB,CAAC;IALKC,MAAM,GAAAN,EAAA;IAAEO,SAAS,GAAAP,EAAA,GAKtB;EAEI,IAAAQ,EAAA,GAA8BpB,QAAQ,CAAC;MAC3C,IAAIS,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEK,IAAI,EAAE;QACjB,OAAO,IAAI;;MAGb,OAAOJ,MAAM,CAACW,SAAS,CAAC;QACtBC,KAAK,EAAEd,YAAY;QACnBS,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ,SAAS;QAC7BM,WAAW,EAAEd,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEc,WAAW;QACjCC,OAAO,EAAEf,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEe;OACnB,CAAC;IACJ,CAAC,CAAC;IAXKC,UAAU,GAAAL,EAAA;IAAEM,aAAa,GAAAN,EAAA,GAW9B;EAEF,IAAMO,qBAAqB,GAAG1B,MAAM,CAAC,KAAK,CAAC;EAC3CC,SAAS,CAAC;IACR,OAAO;MACLyB,qBAAqB,CAACC,OAAO,GAAG,IAAI;IACtC,CAAC;EACH,CAAC,EAAE,EAAE,CAAC;EAEN,IAAMC,GAAG,GAAG5B,MAAM,CAAC;IAAES,MAAM,EAAAA,MAAA;IAAEF,YAAY,EAAAA,YAAA;IAAEC,OAAO,EAAAA;EAAA,CAAE,CAAC;EACrDP,SAAS,CAAC;;IACR,IAAI4B,iBAAiB,GAAGrB,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEqB,iBAAiB;IAClD,IAAI,OAAOA,iBAAiB,KAAK,UAAU,EAAE;MAC3CA,iBAAiB,GAAG,CAAC,CAACA,iBAAiB,CAACrB,OAAQ,CAAC;;IAGnD,IAAIA,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEK,IAAI,EAAE;MACjB,IAAI,EAACL,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEK,IAAI,MAAK,EAAC,CAAAF,EAAA,GAAAiB,GAAG,CAACD,OAAO,CAACnB,OAAO,cAAAG,EAAA,uBAAAA,EAAA,CAAEE,IAAI,KAAIa,qBAAqB,CAACC,OAAO,EAAE;QAClFT,SAAS,CAAC;UACRN,OAAO,EAAE,KAAK;UACdG,IAAI,EAAE,KAAK,CAAC;UACZD,KAAK,EAAE,KAAK,CAAC;UACbE,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ;SACrB,CAAC;QACFS,aAAa,CAAC,IAAI,CAAC;QACnBC,qBAAqB,CAACC,OAAO,GAAG,KAAK;;KAExC,MAAM,IACJE,iBAAiB,KAAK,KAAK,KACzBpB,MAAM,KAAKmB,GAAG,CAACD,OAAO,CAAClB,MAAM,IAC5BF,YAAY,KAAKqB,GAAG,CAACD,OAAO,CAACpB,YAAY,IACzC,CAAAC,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEc,WAAW,OAAK,CAAAH,EAAA,GAAAS,GAAG,CAACD,OAAO,CAACnB,OAAO,cAAAW,EAAA,uBAAAA,EAAA,CAAEG,WAAW,KACzD,EAACd,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEK,IAAI,MAAK,EAAC,CAAAiB,EAAA,GAAAF,GAAG,CAACD,OAAO,CAACnB,OAAO,cAAAsB,EAAA,uBAAAA,EAAA,CAAEjB,IAAI,KAC7C,CAACX,KAAK,CAACM,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ,SAAS,EAAE,CAAAe,EAAA,GAAAH,GAAG,CAACD,OAAO,CAACnB,OAAO,cAAAuB,EAAA,uBAAAA,EAAA,CAAEf,SAAS,CAAC,CAAC,IAC/DU,qBAAqB,CAACC,OAAO,EAC7B;MACAT,SAAS,CAAC;QACRN,OAAO,EAAE,IAAI;QACbG,IAAI,EAAE,KAAK,CAAC;QACZD,KAAK,EAAE,KAAK,CAAC;QACbE,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ;OACrB,CAAC;MACFS,aAAa,CAAChB,MAAM,CAACW,SAAS,CAAC;QAC7BC,KAAK,EAAEd,YAAY;QACnBS,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ,SAAS;QAC7BM,WAAW,EAAEd,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEc,WAAW;QACjCC,OAAO,EAAEf,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEe;OACnB,CAAC,CAAC;MACHG,qBAAqB,CAACC,OAAO,GAAG,KAAK;;IAGvCK,MAAM,CAACC,MAAM,CAACL,GAAG,CAACD,OAAO,EAAE;MAAElB,MAAM,EAAAA,MAAA;MAAEF,YAAY,EAAAA,YAAA;MAAEC,OAAO,EAAAA;IAAA,CAAE,CAAC;EAC/D,CAAC,EAAE,CAACC,MAAM,EAAEF,YAAY,EAAEC,OAAO,EAAEkB,qBAAqB,CAACC,OAAO,CAAC,CAAC;EAElE1B,SAAS,CAAC;IACR,IAAI,CAACuB,UAAU,EAAE;MACf;;IAGF,IAAMjB,YAAY,GAAGiB,UAAU,CAACJ,SAAS,CAAC;MACxCc,IAAI,EAAJ,SAAAA,CAAKC,WAAW;;QACd,IAAMlB,MAAM,GAAG;UACbL,OAAO,EAAE,KAAK;UAGdG,IAAI,EAAEoB,WAAW,CAACpB,IAAK;UACvBD,KAAK,EAAE,KAAK,CAAC;UACbE,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ;SACrB;QACDE,SAAS,CAACD,MAAM,CAAC;QAEjB,CAAAE,EAAA,IAAAR,EAAA,GAAAiB,GAAG,CAACD,OAAO,CAACnB,OAAO,cAAAG,EAAA,uBAAAA,EAAA,CAAEyB,kBAAkB,cAAAjB,EAAA,uBAAAA,EAAA,CAAAkB,IAAA,CAAA1B,EAAA,EAAG;UACxCF,MAAM,EAAAA,MAAA;UACN6B,gBAAgB,EAAErB;SACnB,CAAC;MACJ,CAAC;MACDH,KAAK,WAAAA,CAACA,KAAK;QACTI,SAAS,CAAC;UACRN,OAAO,EAAE,KAAK;UACdG,IAAI,EAAE,KAAK,CAAC;UACZD,KAAK,EAAAA,KAAA;UACLE,SAAS,EAAER,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ;SACrB,CAAC;MACJ,CAAC;MACDuB,QAAQ,WAAAA,CAAA;;QACN,CAAApB,EAAA,IAAAR,EAAA,GAAAiB,GAAG,CAACD,OAAO,CAACnB,OAAO,cAAAG,EAAA,uBAAAA,EAAA,CAAE6B,sBAAsB,cAAArB,EAAA,uBAAAA,EAAA,CAAAkB,IAAA,CAAA1B,EAAA,CAAI;MACjD;KACD,CAAC;IAEF,OAAO;MACLJ,YAAY,CAACkC,WAAW,EAAE;IAC5B,CAAC;EACH,CAAC,EAAE,CAACjB,UAAU,CAAC,CAAC;EAEhB,OAAOP,MAAM;AACf","ignoreList":[]},"metadata":{},"sourceType":"module"}